<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Invoice Generator</title>
    
    <meta name="theme-color" content="#2d3748">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="icon.svg">

    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Invoice PDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Excel Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Arimo:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* UI Font */
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; -webkit-tap-highlight-color: transparent; }
        /* Invoice Font */
        .a4-page { font-family: 'Arimo', sans-serif; }
        :root { --border-color: #000; --page-padding: 15mm; }

        .input-label { display: block; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: #64748b; margin-bottom: 0.5rem; }
        .inp { width: 100%; border-radius: 0.375rem; border: 1px solid #cbd5e1; padding: 0.5rem 0.75rem; font-size: 0.875rem; color: #1e293b; transition: all 0.2s; background-color: #fff; }
        .inp:focus { outline: none; border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }
        
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.5rem 1rem; font-weight: 500; border-radius: 0.375rem; transition: all 0.2s; font-size: 0.875rem; gap: 0.5rem; cursor: pointer; }
        .btn-primary { background-color: #4f46e5; color: white; }
        .btn-secondary { background-color: #fff; color: #475569; border: 1px solid #cbd5e1; }
        .btn-danger { color: #ef4444; background: #fef2f2; border: 1px solid #fecaca; padding: 0.25rem 0.5rem; }
        /* Excel Button Style */
        .btn-success { background-color: #10b981; color: white; border: none; }
        .btn-success:hover { background-color: #059669; }

        .card { background: white; border-radius: 0.5rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); padding: 1.25rem; margin-bottom: 1rem; border: 1px solid #e2e8f0; }

        .a4-page { width: 210mm; height: 296mm; background: white; color: #000; font-size: 10pt; line-height: 1.3; box-sizing: border-box; margin: 0 auto 20px auto; padding: var(--page-padding); position: relative; box-shadow: 0 10px 30px -10px rgba(0,0,0,0.3); overflow: hidden; display: flex; flex-direction: column; flex-shrink: 0; }
        .pdf-mode .a4-page { margin: 0 !important; box-shadow: none !important; border: none !important; }
        .pdf-mode { gap: 0 !important; margin: 0 !important; padding: 0 !important; }
        .invoice-border-box { border: 1px solid var(--border-color); display: flex; flex-direction: column; flex: 1; height: 100%; }
        .row { display: flex; border-bottom: 1px solid var(--border-color); }
        .col { padding: 4px; border-right: 1px solid var(--border-color); }
        .col:last-child { border-right: none; }
        .row:last-child { border-bottom: none; }
        .items-container-row { flex: 1; border-bottom: 1px solid var(--border-color); display: flex; flex-direction: column; min-height: 0; }
        .header-title { text-align: center; font-weight: bold; padding: 5px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; flex-shrink: 0; }
        .page-content { display: flex; flex-direction: column; height: 100%; flex: 1; }
        .bold { font-weight: 700; }
        .small { font-size: 9pt; }
        .w-50 { width: 50%; }
        .sub-grid { display: grid; grid-template-columns: 1fr 1fr; border-bottom: 1px solid var(--border-color); }
        .sub-grid > div { padding: 2px 4px; border-right: 1px solid var(--border-color); }
        .sub-grid > div:last-child { border-right: none; }
        .items-table { width: 100%; height: 100%; border-collapse: collapse; }
        .items-table th { border-bottom: 1px solid var(--border-color); border-right: 1px solid var(--border-color); font-weight: normal; text-align: center; font-size: 9pt; }
        .items-table td { border-right: 1px solid var(--border-color); padding: 4px; vertical-align: top; }
        .items-table td:last-child, .items-table th:last-child { border-right: none; }
        .tax-analysis-table { width: 100%; border-collapse: collapse; }
        .tax-analysis-table th, .tax-analysis-table td { border: 1px solid var(--border-color); padding: 2px; text-align: center; font-size: 9pt; }
        .tax-row { font-style: italic; font-weight: bold; font-size: 9pt; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .text-left { text-align: left; }
        .static-height { flex-shrink: 0; }

        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; transform: none !important; }
            .a4-page { box-shadow: none; margin: 0; page-break-after: always; }
            .a4-page:last-child { page-break-after: auto; }
        }

        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background-color: #fff; padding: 20px; border-radius: 8px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .modal.show { display: flex; }
        #auth-screen { position: fixed; z-index: 200; inset: 0; background: #f3f4f6; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        
        /* BADGES */
        .badge { padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 600; cursor: pointer; display: inline-block; }
        .badge-red { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .badge-green { background-color: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .badge-yellow { background-color: #fef9c3; color: #854d0e; border: 1px solid #fde047; }
    </style>
</head>
<body class="bg-gray-200 p-2 md:p-4">

    <div id="auth-screen">
        <div class="text-center bg-white p-8 rounded-lg shadow-xl">
            <h1 class="text-2xl font-bold text-gray-800 mb-2">Invoice Generator</h1>
            <p class="text-gray-500 mb-6">Login to sync your data</p>
            <button onclick="googleLogin()" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded shadow hover:bg-gray-50 font-bold flex items-center justify-center w-full">
                <span class="mr-2"></span> Sign in with Google
            </button>
        </div>
    </div>

    <div class="flex flex-col lg:flex-row gap-6">
        <!-- EDITOR -->
        <div class="w-full lg:w-1/3 bg-white p-4 md:p-6 rounded shadow-lg h-auto lg:h-[95vh] lg:overflow-y-auto lg:sticky lg:top-4">
            <div class="flex flex-wrap gap-2 mb-4 border-b pb-4">
                <button onclick="openModal('ledger-modal')" class="bg-gray-100 text-gray-700 px-3 py-1 rounded text-xs font-bold hover:bg-gray-200 flex-1">Ledger</button>
                <button onclick="openModal('history-modal')" class="bg-gray-100 text-gray-700 px-3 py-1 rounded text-xs font-bold hover:bg-gray-200 flex-1">History</button>
                <button onclick="openModal('settings-modal')" class="bg-gray-100 text-gray-700 px-3 py-1 rounded text-xs font-bold hover:bg-gray-200 flex-1">Settings</button>
                <button onclick="logout()" class="bg-red-100 text-red-600 px-3 py-1 rounded text-xs font-bold hover:bg-red-200">Log Out</button>
            </div>

            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-blue-700">Invoice Details</h2>
            </div>
            
            <!-- Action Buttons: Download & Share -->
            <div class="grid grid-cols-4 gap-2 mb-6">
                <button onclick="generatePDF()" class="col-span-3 bg-green-600 text-white py-3 rounded font-bold hover:bg-green-700 shadow flex justify-center items-center gap-2">
                    <span></span> Download PDF
                </button>
                <button onclick="shareInvoice()" class="col-span-1 bg-indigo-600 text-white py-3 rounded font-bold hover:bg-indigo-700 shadow flex justify-center items-center" title="Share Bill">
                    <span class="text-xl">Share</span>
                </button>
            </div>

            <div class="input-group bg-gray-50">
                <label class="input-label">Invoice Info</label>
                <select id="inp-doc-type" class="inp mb-2" onchange="updateAll()">
                    <option value="Tax Invoice">Tax Invoice</option>
                    <option value="Proforma Invoice">Proforma Invoice</option>
                    <option value="Delivery Challan">Delivery Challan</option>
                    <option value="Quotation">Quotation</option>
                </select>
                <div class="grid grid-cols-2 gap-2">
                    <input type="text" id="inp-inv-no" class="inp" placeholder="Invoice No" oninput="updateAll()">
                    <input type="text" id="inp-date" value="15-Nov-25" class="inp" placeholder="Date" oninput="updateAll()">
                </div>
                <input type="text" id="inp-vehicle" value="" class="inp mt-2" placeholder="Vehicle Number" oninput="updateAll()">
            </div>

            <div class="input-group bg-blue-50">
                <div class="flex justify-between items-end mb-2">
                    <label class="input-label text-blue-800 mb-0">Buyer (Bill To)</label>
                    <button onclick="saveBuyer()" class="bg-blue-600 text-white text-xs px-2 py-1 rounded hover:bg-blue-700 transition">ðŸ’¾ Save Buyer</button>
                </div>
                <select id="buyer-select" class="inp mb-2 bg-white" onchange="loadBuyerDetails()">
                    <option value="">-- Select Saved Buyer --</option>
                </select>
                <input type="text" id="inp-bill-name" value="Aglo Solutions" class="inp mb-2" placeholder="Company Name" oninput="syncAddress()">
                <textarea id="inp-bill-addr" rows="3" class="inp mb-2" placeholder="Address" oninput="syncAddress()">F-63 A, Vipul World, Sector -48, Gurgaon
Haryana-122001</textarea>
                <div class="grid grid-cols-3 gap-2 mb-2">
                    <input type="text" id="inp-bill-state" value="Haryana" class="col-span-2 inp" placeholder="State Name" oninput="syncAddress()">
                    <input type="text" id="inp-bill-code" value="06" class="inp" placeholder="Code" oninput="syncAddress()">
                </div>
                <input type="text" id="inp-bill-gst" value="06AEZPC9970N1ZG" class="inp" placeholder="GSTIN" oninput="syncAddress()">
            </div>

            <div class="input-group bg-orange-50">
                <div class="flex justify-between items-center mb-2">
                    <label class="input-label text-orange-800">Consignee (Ship To)</label>
                    <div class="flex items-center text-xs">
                        <input type="checkbox" id="same-addr" class="mr-1" onchange="syncAddress()" checked>
                        <label for="same-addr">Same as Bill To</label>
                    </div>
                </div>
                <input type="text" id="inp-ship-name" class="inp mb-2" placeholder="Company Name" oninput="updateAll()">
                <textarea id="inp-ship-addr" rows="3" class="inp mb-2" placeholder="Address" oninput="updateAll()"></textarea>
                <div class="grid grid-cols-3 gap-2 mb-2">
                    <input type="text" id="inp-ship-state" class="col-span-2 inp" placeholder="State Name" oninput="updateAll()">
                    <input type="text" id="inp-ship-code" class="inp" placeholder="Code" oninput="updateAll()">
                </div>
                <input type="text" id="inp-ship-gst" class="inp" placeholder="GSTIN" oninput="updateAll()">
            </div>

            <div class="input-group">
                <div class="flex justify-between items-center mb-2">
                    <label class="input-label">Items</label>
                    <button onclick="addItem()" class="bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600">+ Add Item</button>
                </div>
                <div id="items-input-container" class="space-y-3"></div>
            </div>
        </div>

        <!-- PREVIEW -->
        <div class="w-full lg:w-2/3 flex justify-center bg-gray-500 p-2 md:p-8 overflow-hidden">
            <div id="preview-wrapper" class="w-full flex justify-center" style="overflow-x: hidden; overflow-y: auto;">
                <div id="print-area" style="transform-origin: top center;">
                    <div class="a4-page" id="page1">
                        <div class="invoice-border-box">
                            <div class="header-title">
                                <span style="flex:1" class="display-doc-type">Tax Invoice</span>
                                <span style="font-weight:normal; font-style:italic">(ORIGINAL FOR RECIPIENT)</span>
                            </div>
                            <div class="page-content"></div>
                        </div>
                        <div class="text-center small mt-1">This is a Computer Generated Invoice</div>
                    </div>
                    <div class="a4-page" id="page2">
                        <div class="invoice-border-box">
                            <div class="header-title">
                                <span style="flex:1" class="display-doc-type">Tax Invoice</span>
                                <span style="font-weight:normal; font-style:italic">(DUPLICATE FOR TRANSPORTER)</span>
                            </div>
                            <div class="page-content"></div>
                        </div>
                        <div class="text-center small mt-1">This is a Computer Generated Invoice</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4">Seller Settings</h2>
            <div class="space-y-3">
                <input type="text" id="set-name" class="inp" placeholder="Company Name">
                <textarea id="set-addr" rows="3" class="inp" placeholder="Full Address"></textarea>
                <input type="text" id="set-gst" class="inp" placeholder="GSTIN/UIN">
                <div class="grid grid-cols-2 gap-2">
                    <input type="text" id="set-state" class="inp" placeholder="State Name">
                    <input type="text" id="set-code" class="inp" placeholder="State Code">
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button onclick="closeModal('settings-modal')" class="px-4 py-2 bg-gray-300 rounded">Cancel</button>
                <button onclick="saveSellerSettings()" class="px-4 py-2 bg-blue-600 text-white rounded">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div id="history-modal" class="modal">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4">Invoice History</h2>
            <div id="history-pdf-area">
                <div class="bg-indigo-50 p-3 rounded mb-3 text-center">
                    <span class="text-xs font-bold uppercase text-indigo-500">Total Balance Due</span>
                    <div id="total-outstanding" class="text-xl font-bold text-indigo-800">â‚¹ 0.00</div>
                </div>
                <div class="overflow-y-auto max-h-60 border rounded p-2 bg-gray-50" id="history-list"></div>
            </div>
            <div class="flex justify-end mt-4 gap-2">
                <button onclick="downloadHistoryExcel()" class="btn btn-success text-xs sm:text-sm">Download Excel</button>
                <button onclick="closeModal('history-modal')" class="px-4 py-2 bg-gray-300 rounded">Close</button>
            </div>
        </div>
    </div>

    <!-- Ledger Modal -->
    <div id="ledger-modal" class="modal">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4">Party Ledger</h2>
            <div class="mb-4">
                <select id="ledger-buyer-select" class="inp bg-gray-50" onchange="renderLedgerTable()">
                    <option value="">Select Party...</option>
                </select>
            </div>
            <div id="ledger-pdf-area">
                <div id="ledger-summary" class="grid grid-cols-3 gap-2 mb-4 text-center hidden">
                    <div class="bg-gray-50 p-2 rounded"><div class="text-xs text-gray-500">Billed</div><div class="font-bold" id="led-billed">0</div></div>
                    <div class="bg-green-50 p-2 rounded"><div class="text-xs text-green-600">Received</div><div class="font-bold text-green-700" id="led-paid">0</div></div>
                    <div class="bg-red-50 p-2 rounded"><div class="text-xs text-red-600">Balance</div><div class="font-bold text-red-700" id="led-balance">0</div></div>
                </div>
                <div class="overflow-y-auto max-h-60 border rounded p-2 bg-gray-50" id="ledger-table-container">
                    <p class="text-sm text-gray-500 text-center">Select a party above.</p>
                </div>
            </div>
            <div class="flex justify-end mt-4 gap-2">
                <button onclick="downloadLedgerExcel()" class="btn btn-success text-xs sm:text-sm">Download Excel</button>
                <button onclick="closeModal('ledger-modal')" class="px-4 py-2 bg-gray-300 rounded">Close</button>
            </div>
        </div>
    </div>

    <!-- Payment Recording Modal -->
    <div id="payment-modal" class="modal">
        <div class="modal-content max-w-sm">
            <h2 class="text-xl font-bold mb-4">Record Payment</h2>
            <p class="text-sm text-gray-600 mb-4" id="pay-modal-details"></p>
            
            <div class="mb-4">
                <label class="input-label">Amount Received (â‚¹)</label>
                <input type="number" id="pay-amount-input" class="inp text-lg font-bold text-green-700" placeholder="0.00">
            </div>

            <div class="flex justify-end gap-2">
                <button onclick="closeModal('payment-modal')" class="px-4 py-2 bg-gray-300 rounded font-medium">Cancel</button>
                <button onclick="submitPayment()" class="px-4 py-2 bg-green-600 text-white rounded font-bold hover:bg-green-700">Save Payment</button>
            </div>
        </div>
    </div>

    <!-- INVOICE TEMPLATE -->
    <template id="invoice-body-template">
        <div class="row static-height">
            <div class="col w-50" style="padding:0;">
                <div style="padding: 4px; border-bottom: 1px solid black;">
                    <div class="bold seller-name"></div>
                    <div class="seller-addr" style="white-space: pre-line;"></div>
                    <div>GSTIN/UIN: <span class="seller-gst"></span></div>
                    <div>State Name : <span class="seller-state"></span>, Code : <span class="seller-code"></span></div>
                </div>
                <div style="padding: 4px; border-bottom: 1px solid black;">
                    <div class="small">Consignee (Ship to)</div>
                    <div class="bold display-ship-name"></div>
                    <div style="white-space: pre-line;" class="display-ship-addr"></div>
                    <div>GSTIN/UIN : <span class="display-ship-gst"></span></div>
                    <div>State Name : <span class="display-ship-state"></span>, Code : <span class="display-ship-code"></span></div>
                </div>
                <div style="padding: 4px;">
                    <div class="small">Buyer (Bill to)</div>
                    <div class="bold display-bill-name"></div>
                    <div style="white-space: pre-line;" class="display-bill-addr"></div>
                    <div>GSTIN/UIN : <span class="display-bill-gst"></span></div>
                    <div>State Name : <span class="display-bill-state"></span>, Code : <span class="display-bill-code"></span></div>
                </div>
            </div>
            <div class="col w-50" style="padding:0;">
                <div class="sub-grid"><div><div class="small">Invoice No.</div><div class="bold display-inv-no"></div></div><div><div class="small">Dated</div><div class="bold display-date"></div></div></div>
                <div class="sub-grid"><div><div class="small">Delivery Note</div><br></div><div><div class="small">Mode/Terms of Payment</div><br></div></div>
                <div class="sub-grid"><div><div class="small">Reference No. & Date.</div><div class="bold display-ref-date"></div></div><div><div class="small">Other References</div><br></div></div>
                <div class="sub-grid"><div><div class="small">Buyer's Order No.</div><br></div><div><div class="small">Dated</div><br></div></div>
                <div class="sub-grid"><div><div class="small">Dispatch Doc No.</div><br></div><div><div class="small">Delivery Note Date</div><br></div></div>
                <div class="sub-grid"><div><div class="small">Vehicle Number</div><div class="bold display-vehicle"></div></div><div><div class="small">Destination</div><br></div></div>
                <div style="padding: 4px; height: 60px;"><div class="small">Terms of Delivery</div></div>
            </div>
        </div>
        <div class="row static-height" style="border-bottom: none;">
            <table class="items-table" style="height: auto;">
                <thead><tr><th width="5%">Sl<br>No.</th><th width="35%">Description of Goods</th><th width="12%">HSN/SAC</th><th width="12%">Quantity</th><th width="10%">Rate</th><th width="8%">per</th><th width="6%">Disc. %</th><th width="12%">Amount</th></tr></thead>
            </table>
        </div>
        <div class="items-container-row"><table class="items-table"><tbody class="tbody-items"></tbody><tfoot><tr style="border-top: 1px solid black; height: 30px;"><td width="5%"></td><td width="35%" class="text-right bold">Total</td><td width="12%"></td><td width="12%" class="bold text-center"><span class="display-total-qty"></span> Pcs</td><td width="10%"></td><td width="8%"></td><td width="6%"></td><td width="12%" class="bold text-right">â‚¹ <span class="display-grand-total"></span></td></tr></tfoot></table></div>
        <div class="static-height">
            <div style="padding: 4px; border-bottom: 1px solid black;"><div class="small">Amount Chargeable (in words) <span style="float:right; font-style:italic;">E. & O.E</span></div><div class="bold display-amount-words"></div></div>
            <div style="padding: 0;"><table class="tax-analysis-table"><thead><tr><th rowspan="2">HSN/SAC</th><th rowspan="2">Taxable<br>Value</th><th colspan="2">CGST</th><th colspan="2">SGST/UTGST</th><th rowspan="2">Total<br>Tax Amount</th></tr><tr><th>Rate</th><th>Amount</th><th>Rate</th><th>Amount</th></tr></thead><tbody><tr><td class="display-hsn"></td><td class="text-right display-taxable-val"></td><td class="text-right">9%</td><td class="text-right display-cgst-val"></td><td class="text-right">9%</td><td class="text-right display-sgst-val"></td><td class="text-right display-total-tax-val"></td></tr><tr class="bold"><td class="text-right">Total</td><td class="text-right display-taxable-val"></td><td></td><td class="text-right display-cgst-val"></td><td></td><td class="text-right display-sgst-val"></td><td class="text-right display-total-tax-val"></td></tr></tbody></table></div>
            <div style="padding: 4px; border-bottom: 1px solid black;"><div class="small">Tax Amount (in words) : <span class="bold display-tax-words"></span></div></div>
            <div class="row" style="border-bottom: none; min-height: 100px;"><div class="col w-50" style="border-right: 1px solid black; padding: 4px;"><div class="small" style="text-decoration: underline;">Declaration</div><div class="small">We declare that this invoice shows the actual price of the goods described and that all particulars are true and correct. </div><div class="small">50% Advance Payment is required to confirm the order and 50% before the dispatch. </div></div><div class="col w-50" style="display: flex; flex-direction: column; justify-content: space-between; padding: 4px;"><div class="small text-right bold seller-sign"></div><br><br><div class="small text-right">Authorised Signatory</div></div></div>
        </div>
    </template>

    <!-- FIREBASE & LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // --- PASTE YOUR FIREBASE CONFIG HERE ---
        const firebaseConfig = {
            apiKey: "AIzaSyAqQiWHLKe3G9o-5LaOUYnQT8ND1MGkIY4",
            authDomain: "invoicegen-dae80.firebaseapp.com",
            projectId: "invoicegen-dae80",
            storageBucket: "invoicegen-dae80.firebasestorage.app",
            messagingSenderId: "277519828876",
            appId: "1:277519828876:web:7c50af248477f9a315f8a9"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let userData = {
            buyers: [],
            products: [],
            history: [],
            seller: { name: "New Fibre India FY:- 2024-25", addr: "PLOT NO 25, VILLAGE KHERI KALAN...", gst: "06CONPD2791E1ZY", state: "Haryana", code: "06" }
        };

        window.googleLogin = async () => {
            try { await signInWithPopup(auth, provider); } 
            catch (error) { console.error(error); alert("Login Failed: " + error.message); }
        };

        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, async (user) => {
            const authScreen = document.getElementById('auth-screen');
            if (user) {
                currentUser = user;
                authScreen.style.display = 'none';
                await loadDataFromCloud();
            } else {
                currentUser = null;
                authScreen.style.display = 'flex';
            }
        });

        async function loadDataFromCloud() {
            if (!currentUser) return;
            const docRef = doc(db, "users", currentUser.uid);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                userData.buyers = data.buyers || [];
                userData.products = data.products || [];
                userData.history = data.history || [];
                userData.seller = data.seller || userData.seller;
            } else {
                await setDoc(docRef, userData);
            }
            window.initUI();
        }

        async function saveDataToCloud() {
            if (!currentUser) return;
            const docRef = doc(db, "users", currentUser.uid);
            await setDoc(docRef, userData, { merge: true });
        }

        // Expose functions
        window.userData = userData;
        window.saveDataToCloud = saveDataToCloud;
    </script>

    <script>
        if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./sw.js').catch(console.log); }

        let items = [{ desc: "FRP Planter-7019 14*14", hsn: "70191100", qty: 53, rate: 400.00 }];
        let currentTotalAmount = 0;
        let currentPaymentIndex = null;

        function initUI() {
            const seller = window.userData.seller || {};
            if(seller.name) {
                ['name', 'addr', 'gst', 'state', 'code'].forEach(k => {
                    const el = document.getElementById('set-'+k);
                    if(el) el.value = seller[k] || "";
                });
            }
            
            const history = window.userData.history || [];
            if(history.length > 0) {
                const lastInv = history[0].invNo;
                const parts = lastInv.match(/^(.*?)(\d+)$/);
                const el = document.getElementById('inp-inv-no');
                if(parts && el) el.value = parts[1] + (parseInt(parts[2]) + 1);
            } else {
                document.getElementById('inp-inv-no').value = "NFI/2025-26/24";
            }

            renderBuyerDropdown();
            renderItemInputs(); 
            updateAll();
            window.fitPreview();
        }

        function openModal(id) { 
            document.getElementById(id).classList.add('show');
            if(id==='history-modal') renderHistory();
            if(id==='ledger-modal') initLedger();
        }
        function closeModal(id) { document.getElementById(id).classList.remove('show'); }

        /* --- EXCEL EXPORT FUNCTIONS --- */
        function downloadHistoryExcel() {
            const history = window.userData.history || [];
            if(history.length === 0) return alert("No history to export.");

            const data = history.map(h => {
                const total = h.amount || 0;
                const paid = h.paidAmount || 0;
                const due = total - paid;
                let status = due <= 1 ? 'Paid' : (paid === 0 ? 'Unpaid' : 'Partial');
                return {
                    "Date": h.date,
                    "Invoice No": h.invNo,
                    "Buyer Name": h.buyer,
                    "Total Amount": total,
                    "Paid Amount": paid,
                    "Balance Due": due,
                    "Status": status,
                    "Generated At": new Date(h.timestamp).toLocaleString()
                };
            });

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "History");
            XLSX.writeFile(wb, "Invoice_History.xlsx");
        }

        function downloadLedgerExcel() {
            const buyer = document.getElementById('ledger-buyer-select').value;
            if(!buyer) return alert("Select a party first.");

            const history = window.userData.history || [];
            const txns = history.filter(h => h.buyer === buyer);
            
            if(txns.length === 0) return alert("No transactions for this party.");

            const data = txns.map(t => ({
                "Date": t.date,
                "Invoice No": t.invNo,
                "Billed Amount": t.amount || 0,
                "Amount Received": t.paidAmount || 0,
                "Balance": (t.amount||0) - (t.paidAmount||0)
            }));

            const billed = txns.reduce((s, t) => s + (t.amount||0), 0);
            const received = txns.reduce((s, t) => s + (t.paidAmount||0), 0);
            const balance = billed - received;

            data.push({});
            data.push({"Date": "SUMMARY", "Invoice No": "", "Billed Amount": "", "Amount Received": "", "Balance": ""});
            data.push({"Date": "Total Billed", "Invoice No": "", "Billed Amount": billed, "Amount Received": "", "Balance": ""});
            data.push({"Date": "Total Received", "Invoice No": "", "Billed Amount": "", "Amount Received": received, "Balance": ""});
            data.push({"Date": "Net Balance", "Invoice No": "", "Billed Amount": "", "Amount Received": "", "Balance": balance});

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Ledger");
            XLSX.writeFile(wb, `Ledger_${buyer.replace(/ /g,'_')}.xlsx`);
        }

        /* WRAPPERS */
        function saveSellerSettings() {
            window.userData.seller = {
                name: document.getElementById('set-name').value,
                addr: document.getElementById('set-addr').value,
                gst: document.getElementById('set-gst').value,
                state: document.getElementById('set-state').value,
                code: document.getElementById('set-code').value
            };
            window.saveDataToCloud();
            closeModal('settings-modal');
            updateAll();
        }

        function saveBuyer() {
            const name = document.getElementById('inp-bill-name').value.trim();
            if (!name) return alert("Enter Name");
            const newB = { 
                name, 
                addr: document.getElementById('inp-bill-addr').value, 
                gst: document.getElementById('inp-bill-gst').value, 
                state: document.getElementById('inp-bill-state').value, 
                code: document.getElementById('inp-bill-code').value 
            };
            const idx = window.userData.buyers.findIndex(b => b.name === name);
            if (idx > -1) window.userData.buyers[idx] = newB; else window.userData.buyers.push(newB);
            window.saveDataToCloud();
            renderBuyerDropdown();
            alert("Buyer Saved!");
        }

        function renderBuyerDropdown() {
            const sel = document.getElementById('buyer-select');
            sel.innerHTML = '<option value="">Select Saved Buyer...</option>';
            (window.userData.buyers || []).forEach((b, i) => {
                sel.innerHTML += `<option value="${i}">${b.name}</option>`;
            });
        }

        function loadBuyerDetails() {
            const idx = document.getElementById('buyer-select').value;
            if(idx === "") return;
            const b = window.userData.buyers[idx];
            if(b) {
                document.getElementById('inp-bill-name').value = b.name||"";
                document.getElementById('inp-bill-addr').value = b.addr||"";
                document.getElementById('inp-bill-gst').value = b.gst||"";
                document.getElementById('inp-bill-state').value = b.state||"";
                document.getElementById('inp-bill-code').value = b.code||"";
                syncAddress();
            }
        }

        function saveProductFromRow(i) {
            const item = items[i];
            if(!item.desc) return alert("Desc req");
            const idx = window.userData.products.findIndex(p => p.desc === item.desc);
            const newP = { desc: item.desc, hsn: item.hsn, rate: item.rate };
            if(idx > -1) { if(confirm("Update product?")) window.userData.products[idx] = newP; else return; }
            else window.userData.products.push(newP);
            window.saveDataToCloud();
            renderItemInputs();
            alert("Product Saved");
        }

        function loadProductToRow(i, el) {
            const idx = el.value;
            if(idx==="") return;
            const p = window.userData.products[idx];
            if(p) { items[i].desc = p.desc; items[i].hsn = p.hsn; items[i].rate = p.rate; renderItemInputs(); updateAll(); }
        }

        /* --- UPDATED HISTORY & PAYMENT LOGIC --- */
        function saveToHistory() {
            const entry = {
                date: document.getElementById('inp-date').value,
                invNo: document.getElementById('inp-inv-no').value,
                buyer: document.getElementById('inp-bill-name').value,
                amount: currentTotalAmount,
                paidAmount: 0, // Partial Payment Tracking
                timestamp: Date.now()
            };
            window.userData.history.unshift(entry);
            if(window.userData.history.length > 100) window.userData.history = window.userData.history.slice(0, 100);
            window.saveDataToCloud();
        }

        function deleteHistoryItem(index) {
            if(!confirm("Are you sure you want to delete this invoice?")) return;
            window.userData.history.splice(index, 1);
            window.saveDataToCloud();
            renderHistory();
            // Refresh ledger if open
            if(document.getElementById('ledger-modal').classList.contains('show')) renderLedgerTable();
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            const h = window.userData.history || [];
            
            // Calculate Total Outstanding (Total - Paid)
            const out = h.reduce((sum, i) => sum + (i.amount - (i.paidAmount || 0)), 0);
            document.getElementById('total-outstanding').innerText = 'â‚¹ ' + out.toLocaleString('en-IN');
            
            if(h.length === 0) { list.innerHTML = '<p class="text-center text-sm">No history.</p>'; return; }
            
            let html = '<table class="w-full text-sm text-left"><thead><tr class="bg-gray-100"><th>No</th><th>Buyer</th><th class="text-right">Amt</th><th class="text-center">Status</th><th class="text-center">Del</th></tr></thead><tbody>';
            
            h.forEach((item, i) => {
                const total = item.amount || 0;
                const paid = item.paidAmount || 0;
                const balance = total - paid;

                let badgeClass = '';
                let badgeText = '';
                
                if (balance <= 1) { 
                    badgeClass = 'badge-green'; badgeText = 'PAID'; 
                } else if (paid === 0) { 
                    badgeClass = 'badge-red'; badgeText = 'UNPAID'; 
                } else { 
                    badgeClass = 'badge-yellow'; badgeText = `DUE: â‚¹${Math.round(balance)}`; 
                }

                html += `<tr class="border-b hover:bg-gray-50 transition">
                    <td class="font-bold p-2 text-xs sm:text-sm">${item.invNo}</td>
                    <td class="truncate max-w-[80px] p-2 text-xs sm:text-sm">${item.buyer}</td>
                    <td class="text-right p-2 text-xs sm:text-sm">â‚¹${total.toLocaleString('en-IN')}</td>
                    <td class="text-center p-2">
                        <span class="badge ${badgeClass}" onclick="openPaymentModal(${i})">${badgeText}</span>
                    </td>
                    <td class="text-center p-2"><button class="text-red-500 font-bold hover:bg-red-100 rounded px-2" onclick="deleteHistoryItem(${i})">âœ•</button></td>
                </tr>`;
            });
            list.innerHTML = html + '</tbody></table>';
        }

        function openPaymentModal(index) {
            currentPaymentIndex = index;
            const item = window.userData.history[index];
            const paid = item.paidAmount || 0;
            const total = item.amount;
            const balance = total - paid;

            document.getElementById('pay-modal-details').innerHTML = 
                `Invoice: <b>${item.invNo}</b><br>
                Total: â‚¹${total.toLocaleString()}<br>
                Balance Due: <span class="text-red-600 font-bold">â‚¹${balance.toLocaleString()}</span>`;
            
            document.getElementById('pay-amount-input').value = balance > 0 ? balance : '';
            openModal('payment-modal');
            setTimeout(() => document.getElementById('pay-amount-input').focus(), 100);
        }

        function submitPayment() {
            if (currentPaymentIndex === null) return;
            const amtInput = document.getElementById('pay-amount-input');
            const addAmount = parseFloat(amtInput.value);

            if (isNaN(addAmount) || addAmount < 0) { return alert("Please enter a valid amount"); }

            const item = window.userData.history[currentPaymentIndex];
            const currentPaid = item.paidAmount || 0;
            
            if (currentPaid + addAmount > item.amount + 5) { // +5 tolerance
                if(!confirm("Amount exceeds balance. Continue?")) return;
            }

            window.userData.history[currentPaymentIndex].paidAmount = currentPaid + addAmount;
            window.saveDataToCloud();
            closeModal('payment-modal');
            renderHistory();
            if(document.getElementById('ledger-modal').classList.contains('show')) renderLedgerTable();
        }

        /* --- LEDGER --- */
        function initLedger() {
            const h = window.userData.history || [];
            const buyers = [...new Set(h.map(x => x.buyer))].sort();
            const sel = document.getElementById('ledger-buyer-select');
            sel.innerHTML = '<option value="">Select Party...</option>';
            buyers.forEach(b => sel.innerHTML += `<option value="${b}">${b}</option>`);
            document.getElementById('ledger-summary').classList.add('hidden');
            document.getElementById('ledger-table-container').innerHTML = '';
        }

        function renderLedgerTable() {
            const b = document.getElementById('ledger-buyer-select').value;
            if(!b) return;
            
            const txns = window.userData.history.map((item, index) => ({...item, originalIndex: index})).filter(x => x.buyer === b);
            
            const billed = txns.reduce((s, t) => s + (t.amount||0), 0);
            const received = txns.reduce((s, t) => s + (t.paidAmount||0), 0);
            const balance = billed - received;
            
            document.getElementById('led-billed').innerText = 'â‚¹ ' + billed.toLocaleString('en-IN');
            document.getElementById('led-paid').innerText = 'â‚¹ ' + received.toLocaleString('en-IN');
            document.getElementById('led-balance').innerText = 'â‚¹ ' + balance.toLocaleString('en-IN');
            document.getElementById('ledger-summary').classList.remove('hidden');

            let html = '<table class="w-full text-sm text-left"><thead><tr class="bg-gray-100"><th>Date</th><th>Inv</th><th class="text-right">Bill</th><th class="text-right">Paid</th><th>Bal</th></tr></thead><tbody>';
            
            txns.forEach(t => {
                const paid = t.paidAmount || 0;
                const bal = (t.amount||0) - paid;
                const col = bal <= 1 ? 'text-green-600' : 'text-red-600';

                html += `<tr class="border-b">
                <td class="p-2 text-xs">${t.date}</td>
                <td class="p-2 font-medium text-xs">${t.invNo}</td>
                <td class="text-right p-2 text-xs">â‚¹${(t.amount||0).toLocaleString('en-IN')}</td>
                <td class="text-right p-2 text-xs text-green-700">â‚¹${paid.toLocaleString('en-IN')}</td>
                <td class="p-2 text-center font-bold text-xs ${col}">â‚¹${bal.toLocaleString('en-IN')}</td>
                </tr>`; 
            });
            document.getElementById('ledger-table-container').innerHTML = html + '</tbody></table>';
        }

        /* ITEM LOGIC */
        function addItem() { items.push({ desc: "", hsn: "", qty: 0, rate: 0 }); renderItemInputs(); updateAll(); }
        function removeItem(i) { if(items.length > 1) { items.splice(i, 1); renderItemInputs(); updateAll(); } }
        function updateItem(i, f, v) { items[i][f] = v; updateAll(); }
        function renderItemInputs() {
            const container = document.getElementById('items-input-container'); container.innerHTML = '';
            const saved = window.userData.products || [];
            let opts = '<option value="">Saved...</option>';
            saved.forEach((p, i) => opts += `<option value="${i}">${p.desc}</option>`);

            items.forEach((item, i) => {
                const div = document.createElement('div'); div.className = "border p-2 rounded bg-gray-50 relative";
                div.innerHTML = `
                    <div class="flex justify-between mb-2 gap-1">
                        <select class="inp py-1 text-xs w-full" onchange="loadProductToRow(${i}, this)">${opts}</select>
                        <button onclick="saveProductFromRow(${i})" class="bg-blue-100 text-blue-600 text-xs px-2 rounded">ðŸ’¾</button>
                        <button onclick="removeItem(${i})" class="text-red-500 px-2 font-bold">âœ•</button>
                    </div>
                    <div class="mb-2"><input type="text" class="inp" placeholder="Description" value="${item.desc}" oninput="updateItem(${i}, 'desc', this.value)"></div>
                    <div class="grid grid-cols-3 gap-2">
                        <input type="text" class="inp" placeholder="HSN" value="${item.hsn}" oninput="updateItem(${i}, 'hsn', this.value)">
                        <input type="number" class="inp" placeholder="Qty" value="${item.qty}" oninput="updateItem(${i}, 'qty', Number(this.value))">
                        <input type="number" class="inp" placeholder="Rate" value="${item.rate}" oninput="updateItem(${i}, 'rate', Number(this.value))">
                    </div>`;
                container.appendChild(div);
            });
        }

        function syncAddress() {
            const same = document.getElementById('same-addr').checked;
            ['name', 'addr', 'gst', 'state', 'code'].forEach(k => {
                const b = document.getElementById(`inp-bill-${k}`);
                const s = document.getElementById(`inp-ship-${k}`);
                if(b && s) {
                    if(same) { s.value = b.value; s.disabled = true; s.classList.add('bg-gray-100'); }
                    else { s.disabled = false; s.classList.remove('bg-gray-100'); }
                }
            });
            updateAll();
        }

        function updateAll() {
            const tpl = document.getElementById('invoice-body-template');
            if(tpl) document.querySelectorAll('.page-content').forEach(e => e.innerHTML = tpl.innerHTML);
            
            // Seller
            const seller = window.userData.seller || {};
            const setTxt = (c, v) => document.querySelectorAll('.'+c).forEach(e => e.innerText = v || '');
            setTxt('seller-name', seller.name); setTxt('seller-addr', seller.addr);
            setTxt('seller-gst', seller.gst); setTxt('seller-state', seller.state);
            setTxt('seller-code', seller.code); setTxt('seller-sign', "for " + (seller.name || ''));

            // Document Type
            setTxt('display-doc-type', document.getElementById('inp-doc-type').value);

            // Basic
            const getVal = (id) => document.getElementById(id)?.value || '';
            setTxt('display-inv-no', getVal('inp-inv-no')); setTxt('display-date', getVal('inp-date'));
            setTxt('display-ref-date', getVal('inp-inv-no') + ' dt. ' + getVal('inp-date')); setTxt('display-vehicle', getVal('inp-vehicle'));

            // Buyers
            ['bill', 'ship'].forEach(t => {
                ['name', 'addr', 'gst', 'state', 'code'].forEach(f => {
                    setTxt(`display-${t}-${f}`, getVal(`inp-${t}-${f}`));
                });
            });

            // Items
            let totalQty = 0, totalTaxable = 0, totalTax = 0, pHsn = items[0]?.hsn || '';
            const rows = items.map((item, i) => {
                const amt = item.qty * item.rate;
                const tax = amt * 0.18; 
                totalQty += item.qty; totalTaxable += amt; totalTax += tax;
                return `<tr><td width="5%" class="text-center">${i+1}</td><td width="35%"><div class="bold">${item.desc}</div><br><div class="text-right tax-row" style="margin-right:10px">Output IGST</div></td><td width="12%">${item.hsn}</td><td width="12%" class="bold text-center">${item.qty} Pcs</td><td width="10%" class="text-right">${item.rate.toFixed(2)}</td><td width="8%" class="text-center">Pcs</td><td width="6%"></td><td width="12%" class="text-right bold"><div>${amt.toLocaleString('en-IN', {minimumFractionDigits:2})}</div><br><div>${tax.toLocaleString('en-IN', {minimumFractionDigits:2})}</div></td></tr>`;
            }).join('');
            
            const spacer = `<tr style="height: 100%;"><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>`;
            document.querySelectorAll('.tbody-items').forEach(e => e.innerHTML = rows + spacer);

            currentTotalAmount = totalTaxable + totalTax;

            setTxt('display-total-qty', totalQty);
            setTxt('display-grand-total', currentTotalAmount.toLocaleString('en-IN', {minimumFractionDigits: 2}));
            setTxt('display-amount-words', "INR " + numberToWords(Math.round(currentTotalAmount)) + " Only");
            
            setTxt('display-hsn', pHsn);
            setTxt('display-taxable-val', totalTaxable.toLocaleString('en-IN', {minimumFractionDigits: 2}));
            setTxt('display-cgst-val', (totalTax/2).toLocaleString('en-IN', {minimumFractionDigits: 2}));
            setTxt('display-sgst-val', (totalTax/2).toLocaleString('en-IN', {minimumFractionDigits: 2}));
            setTxt('display-total-tax-val', totalTax.toLocaleString('en-IN', {minimumFractionDigits: 2}));
            setTxt('display-tax-words', "INR " + numberToWords(Math.round(totalTax)) + " Only");

            if(window.fitPreview) window.fitPreview();
        }

        function numberToWords(n) {
            const a = ['','One ','Two ','Three ','Four ','Five ','Six ','Seven ','Eight ','Nine ','Ten ','Eleven ','Twelve ','Thirteen ','Fourteen ','Fifteen ','Sixteen ','Seventeen ','Eighteen ','Nineteen '];
            const b = ['','','Twenty','Thirty','Forty','Fifty','Sixty','Seventy','Eighty','Ninety'];
            n = ('000000000' + n).substr(-9);
            const n_crore = Number(n.substr(0, 2)), n_lakh = Number(n.substr(2, 2)), n_thousand = Number(n.substr(4, 2)), n_hundred = Number(n.substr(6, 1)), n_unit = Number(n.substr(7, 2));
            let str = '';
            const convert = (num) => num < 20 ? a[num] : b[Math.floor(num/10)] + ' ' + a[num%10];
            if (n_crore) str += convert(n_crore) + 'Crore ';
            if (n_lakh) str += convert(n_lakh) + 'Lakh ';
            if (n_thousand) str += convert(n_thousand) + 'Thousand ';
            if (n_hundred) str += convert(n_hundred) + 'Hundred ';
            if (n_unit) str += convert(n_unit);
            return str.trim();
        }

        // Force Fit for Mobile
        window.fitPreview = () => {
            const container = document.getElementById('preview-wrapper');
            const element = document.getElementById('print-area');
            if (!container || !element) return;
            element.style.transform = 'none';
            const containerWidth = container.clientWidth;
            const contentWidth = 800; 
            if (containerWidth < contentWidth) {
                const scale = containerWidth / contentWidth;
                element.style.transform = `scale(${scale})`;
                const totalHeight = element.scrollHeight;
                container.style.height = (totalHeight * scale) + 'px';
                container.style.overflow = 'hidden';
            } else {
                element.style.transform = 'none';
                container.style.height = 'auto';
                container.style.overflowX = 'auto';
            }
        }
        window.addEventListener('resize', window.fitPreview);

        /* --- PDF & SHARE LOGIC --- */
        async function generatePDF() {
            const element = document.getElementById('print-area');
            const originalTransform = element.style.transform;
            element.style.transform = 'none';
            element.classList.add('pdf-mode');

            let invNo = document.getElementById('inp-inv-no').value.trim() || "Invoice";
            const safeFilename = invNo.replace(/\//g, '-') + '.pdf';

            saveToHistory();

            const opt = { margin: 0, filename: safeFilename, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, scrollY: 0 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
            
            try {
                await html2pdf().set(opt).from(element).save();
            } catch(err) { console.error(err); }
            finally {
                element.style.transform = originalTransform;
                element.classList.remove('pdf-mode');
            }
        }

        async function shareInvoice() {
            const element = document.getElementById('print-area');
            const invNo = document.getElementById('inp-inv-no').value.trim() || "Invoice";
            const buyer = document.getElementById('inp-bill-name').value;
            const date = document.getElementById('inp-date').value;
            const total = currentTotalAmount.toLocaleString('en-IN');
            const seller = window.userData.seller.name || "Us";
            
            const btn = event.currentTarget;
            const oldHtml = btn.innerHTML;
            btn.innerHTML = 'âŒ›';
            
            try {
                const originalTransform = element.style.transform;
                element.style.transform = 'none';
                element.classList.add('pdf-mode');

                const opt = { margin: 0, filename: `INV-${invNo}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, scrollY: 0 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
                const pdfBlob = await html2pdf().set(opt).from(element).output('blob');
                
                element.style.transform = originalTransform;
                element.classList.remove('pdf-mode');

                const file = new File([pdfBlob], `Invoice_${invNo}.pdf`, { type: 'application/pdf' });

                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    await navigator.share({
                        title: `Invoice ${invNo}`,
                        text: `Here is the invoice ${invNo} from ${seller}.`,
                        files: [file]
                    });
                } else {
                    // Fallback to WhatsApp Link
                    const text = `*INVOICE SUMMARY*\n\nTo: ${buyer}\nInv No: ${invNo}\nDate: ${date}\nAmount: â‚¹${total}\n\nPlease contact ${seller} for the PDF file.`;
                    window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
                }
                saveToHistory();
            } catch (err) {
                console.error("Share failed:", err);
                alert("Sharing failed. Try downloading.");
            } finally {
                btn.innerHTML = oldHtml;
            }
        }
    </script>
</body>

</html>
